#!/bin/bash
# Final message could be something like "tid $tid: $st - $et: $diff $erm"
# Other Ideas: Add color for diff time over certain value. Add color for ERM. Cut out extra ERM text.

PRODLOGS=/web/www.texes-ets.org/public/logs
SVS='234'
ACTIONS='ReserveAppointment\|RescheduleAppointment\|CancelAppointment'
#ACTIONS='ReserveAppointment\|RescheduleAppointment'
#ACTIONS='CancelAppointment'
STUDENTIDS=''

#transactionIds=$( grep -h "Thu, 07 May 2015" $PRODLOGS/web0[$SVS]*xml_sent.log* | grep "$ACTIONS" | grep -o '<transactionID>[0-9]\+' | grep -o '[0-9]\+' | sort )
transactionIds=$( grep ERM3038 $PRODLOGS/web0[$SVS]*xml_rec* | grep 'Could not invoke' | grep '31 May 2015 \(19\|20\|21\|22\|23\)\|01 Jun 2015 0[0-7]' | grep 'SSA.\(Cancel\)' | grep -o '<transactionID>[0-9]\+' | grep -o '[0-9]\+' )
#echo "$transactionIds"
#echo "\"TransID\",\"StudentID\",\"RegID\",\"Action\""
echo "\"StudentID\",\"RegID\",\"Action\""
#echo "\"StudentID\",\"RegID\",\"ExamStart\",\"Action\""
#echo "\"TransID\",\"StudentID\",\"Action\""
#echo "|TransID|StudentID|RegID|Action|"
#echo "|RegID|StudentID|TransID|Action|"
for id in $transactionIds
do
	studentid=$( grep -h "$id" $PRODLOGS/web0[$SVS]*xml_sent.log* | grep -o '<clientCandidateID>[0-9]\+<' | grep -o '[0-9]\+' )
	examid=$( grep -h "$id" $PRODLOGS/web0[$SVS]*xml_sent.log* | grep -o '<clientAppointmentID\( xmlns=""\)\?>[0-9]\+<' | grep -o '[0-9]\+' )
	action=$( grep -h "$id" $PRODLOGS/web0[$SVS]*xml_sent.log* | grep -o '<action>[^<]\+' | grep -o 'SSA[^<]\+' )
	#examtime=$( grep -h "$id" $PRODLOGS/web0[$SVS]*xml_sent.log* | grep -o '<startTime>[^<]\+' | cut -d'>' -f2 )

	#STUDENTIDS="${STUDENTIDS},${studentid}"

	#echo "\"${id}\",\"${studentid}\",\"${examid}\",\"${action}\""
	echo "\"${studentid}\",\"${examid}\",\"${action}\""
	#echo "\"${studentid}\",\"${examid}\",\"${examtime}\",\"${action}\""
	#echo "|${id}|${studentid}|${examid}|${action}|"
	#echo "|${examid}|${studentid}|${id}|${action}|"
done

#echo $STUDENTIDS
